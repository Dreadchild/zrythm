# -----------------------
#  dirs/names/files
#  ----------------------
ifdef RELEASE
	BUILD_DIR = build/release
else
	BUILD_DIR = build/debug
endif
OBJ_DIR = $(BUILD_DIR)/obj
BIN_NAME = zrythm
SRC_DIR = src
INC_DIR = inc
DATA_DIR = data

CC = @CC@
DEFS = @DEFS@
INSTALL = install
INSTALL_DATA = ${INSTALL} -m 644
INSTALL_PROGRAM = ${INSTALL}
LDFLAGS = @LDFLAGS@
MKDIR_P = mkdir -p
GLIB_COMPILE_SCHEMAS = @GLIB_COMPILE_SCHEMAS@
gsettingsschemadir = @gsettingsschemadir@
OBJEXT = @OBJEXT@
PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_STRING = @PACKAGE_STRING@
PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_URL = @PACKAGE_URL@
PACKAGE_VERSION = @PACKAGE_VERSION@
PATH_SEPARATOR = @PATH_SEPARATOR@
PKG_CONFIG = @PKG_CONFIG@
SHELL = @SHELL@
srcdir = @srcdir@

# test

# Installation directory variables
bindir = @bindir@
datadir = @datadir@
datarootdir = @datarootdir@
docdir = @docdir@
htmldir = @htmldir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
localedir = @localedir@
localstatedir = @localstatedir@
mandir = @mandir@
pdfdir = @pdfdir@
prefix = @prefix@
sharedstatedir = @sharedstatedir@
sysconfdir = @sysconfdir@


# library CFLAGS
GTK_CFLAGS = @GTK_CFLAGS@
JACK_CFLAGS = @JACK_CFLAGS@
LILV_CFLAGS = @LILV_CFLAGS@
LV2_CFLAGS = @LV2_CFLAGS@
PANGOFT2_CFLAGS = @PANGOFT2_CFLAGS@
SUIL_CFLAGS = @SUIL_CFLAGS@

# library LIBS
GTK_LIBS = @GTK_LIBS@
JACK_LIBS = @JACK_LIBS@
LILV_LIBS = @LILV_LIBS@
LV2_LIBS = @LV2_LIBS@
PANGO_LIBS = @PANGO_LIBS@
PANGOFT2_LIBS = @PANGOFT2_LIBS@
SUIL_LIBS = @SUIL_LIBS@

DEFAULT_INCLUDES = -I. -I./$(INC_DIR) -I./$(SRC_DIR)

ifdef RELEASE
	DEFAULT_CFLAGS = -O3
else
	DEFAULT_CFLAGS = -g -O0
endif

CFLAGS = -Wall -rdynamic \
						$(DEFAULT_INCLUDES) \
						$(GTK_CFLAGS) \
						$(JACK_CFLAGS) \
						$(LV2_CFLAGS) \
						$(LILV_CFLAGS) \
						$(SUIL_CFLAGS) \
						$(PANGO_CFLAGS) \
						$(PANGOFT2_CFLAGS) \
						$(DEFAULT_CFLAGS)

LDFLAGS =	$(GTK_LIBS) \
			    $(JACK_LIBS) \
			    $(LV2_LIBS) \
			    $(LILV_LIBS) \
				  $(SUIL_LIBS) \
				  $(PANGO_LIBS) \
				  $(PANGOFT2_LIBS) \
			    -lm \
					-lpthread

built_src = $(BUILD_DIR)/resources.c

built_obj = $(foreach src_file,$(built_src),$(OBJ_DIR)/$(subst .c,.$(OBJEXT),$(subst $(BUILD_DIR)/,,$(src_file))))

src = $(wildcard src/*.c) \
			$(wildcard src/audio/*.c) \
			$(wildcard src/gui/*.c) \
			$(wildcard src/gui/widgets/*.c) \
			$(wildcard src/plugins/*.c) \
			$(wildcard src/plugins/lv2/*.c) \
			$(wildcard src/plugins/lv2/zix/*.c) \
			$(wildcard src/utils/*.c)

obj = $(foreach src_file,$(src),$(OBJ_DIR)/$(subst .c,.$(OBJEXT),$(subst $(SRC_DIR)/,,$(src_file))))

#dep = $(obj:.$(OBJEXT)=.d)  # one dependency file for each source

# FIXME g settings related stuff
gsettings_SCHEMAS = $(DATA_DIR)/online.alextee.zrythm.gschema.xml
#EXTRA_DIST = $(gsettings_SCHEMAS)

# desktop file
desktopdir = $(datadir)/applications
desktop_DATA = $(DATA_DIR)/zrythm.desktop

#the application icon
appicondir=$(datadir)/icons/hicolor/scalable/apps
appicon_DATA = resources/z.svg


# -----------------------------
#  rules
#  ----------------------------

all: directories $(BUILD_DIR)/$(BIN_NAME)

$(BUILD_DIR)/resources.c: $(SRC_DIR)/zrythm.gresource.xml \
	resources/ui/*.ui \
	resources/theme.css \
	resources/*.svg
	$(MKDIR_P) $(BUILD_DIR)
	glib-compile-resources $(SRC_DIR)/zrythm.gresource.xml --target=$(BUILD_DIR)/resources.c \
	--generate-source --sourcedir=resources

#-include $(dep)   # include all dep files in the makefile

# rule to generate a dep file by using the C preprocessor
# (see man cpp for details on the -MM and -MT options)
#$(OBJ_DIR)/%.d: %.c
	#$(eval TMP_FILE := $(subst $(SRC_DIR)/,,$@))
	#$(eval TMP_DIR := $(dir $(TMP_FILE)))
	#$(MKDIR_P) $(TMP_DIR)
	#@$(CPP) $(CFLAGS) $< -MM -MT $(subst $(SRC_DIR)/,,$(@:.d=.$(OBJEXT))) >$(TMP_FILE)

$(BUILD_DIR)/$(BIN_NAME): $(obj) $(built_obj)
	$(CC) -o $@ $^ $(LDFLAGS)

$(OBJ_DIR)/%.$(OBJEXT): $(SRC_DIR)/%.c
	$(MKDIR_P) $(dir $@)
	$(CC) -c -o $@ $^ $(LDFLAGS) $(CFLAGS)

# built sources
$(OBJ_DIR)/%.$(OBJEXT): $(BUILD_DIR)/%.c
	$(MKDIR_P) $(dir $@)
	$(CC) -c -o $@ $^ $(LDFLAGS) $(CFLAGS)
	rm -f @^

.PHONY: directories


directories: ${BUILD_DIR} $(OBJ_DIR)

${BUILD_DIR}:
	${MKDIR_P} ${BUILD_DIR}

$(OBJ_DIR):
	$(MKDIR_P) $(OBJ_DIR)

.PHONY: clean
clean:
	rm -rf $(BUILD_DIR)/*

.PHONY: install
install: $(BUILD_DIR)/$(BIN_NAME) install-appicon-data install-desktop-data install-gschemas
	mkdir -p $(DESTDIR)$(bindir)
	$(INSTALL) $< $(DESTDIR)$(bindir)/$(BIN_NAME)

.PHONY: uninstall
uninstall:
	rm -f $(DESTDIR)$(PREFIX)/bin/$(BIN_NAME)

.PHONY: install-appicon-data
install-appicon-data: $(appicon_DATA)
	$(INSTALL_DATA) $< "$(DESTDIR)$(appicondir)"

.PHONY: install-gschemas
install-gschemas: $(gsettings_SCHEMAS)
	$(INSTALL) $< $(gsettingsschemadir)/
	$(GLIB_COMPILE_SCHEMAS) $(gsettingsschemadir)

.PHONY: install-desktop
install-desktop-data: $(desktop_DATA)
	$(INSTALL_DATA) $< "$(DESTDIR)$(desktopdir)"

