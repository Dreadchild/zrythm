#
#  Copyright (C) 2018-2019 Alexandros Theodotou
#
#  This file is part of Zrythm
#
#  Zrythm is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  Zrythm is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with Zrythm.  If not, see <https://www.gnu.org/licenses/>.
#

# Add .d to Make's recognized suffixes.
SUFFIXES += .d

# variables
WINDOWS=@WINDOWS@
LINUX=@LINUX@
OSX=@OSX@
PACKAGE_MODE=@PACKAGE_MODE@
RELEASE=@RELEASE@
PROFILING=@PROFILING@

# -----------------------
#  dirs/names/files
#  ----------------------
ifeq ($(RELEASE),1)
	BUILD_DIR = build/release
else
	BUILD_DIR = build/debug
endif
OBJ_DIR = $(BUILD_DIR)/obj
DEP_DIR = $(BUILD_DIR)/dep
BIN = zrythm
SRC_DIR = src
INC_DIR = inc
DATA_DIR = data
FONTS_DIR = resources/fonts
ICONS_DIR = resources/icons
SUIL_BUILD_DIR = ext/suil/build
CYAML_BUILD_DIR = ext/libcyaml/build/release
SUIL_SRC_DIR = ext/suil
CYAML_SRC_DIR = ext/libcyaml

CC = @CC@
DEFS = @DEFS@
INSTALL = install
INSTALL_DATA = ${INSTALL} -m 644
INSTALL_PROGRAM = ${INSTALL}
INSTALL_FONT = ${INSTALL} -m 644
LDFLAGS = @LDFLAGS@
MKDIR_P = mkdir -p
GLIB_COMPILE_SCHEMAS = @GLIB_COMPILE_SCHEMAS@
# doesn't work in prefixes like /opt/...
#gsettingsschemadir = @gsettingsschemadir@
OBJEXT = @OBJEXT@
PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_STRING = @PACKAGE_STRING@
PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_URL = @PACKAGE_URL@
PACKAGE_VERSION = @PACKAGE_VERSION@
PATH_SEPARATOR = @PATH_SEPARATOR@
PKG_CONFIG = @PKG_CONFIG@
SHELL = @SHELL@
srcdir = @srcdir@
gsettingsschemadir = `@PKG_CONFIG@ --variable=prefix glib-2.0`/share/glib-2.0/schemas

# Installation directory variables
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
datadir = @datadir@
datarootdir = @datarootdir@
docdir = @docdir@
fontdir = @datarootdir@/fonts
htmldir = @htmldir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
localedir = @localedir@
localstatedir = @localstatedir@
mandir = @mandir@
pdfdir = @pdfdir@
sharedstatedir = @sharedstatedir@
sysconfdir = @sysconfdir@


# library CFLAGS
#LIBCYAML_CFLAGS = @LIBCYAML_CFLAGS@
LIBYAML_CFLAGS = @LIBYAML_CFLAGS@
FFMPEG_CFLAGS = @FFMPEG_CFLAGS@
GTK3_CFLAGS = @GTK3_CFLAGS@
JACK_CFLAGS = @JACK_CFLAGS@
LIBDAZZLE_CFLAGS = @LIBDAZZLE_CFLAGS@
LILV_CFLAGS = @LILV_CFLAGS@
LV2_CFLAGS = @LV2_CFLAGS@
#SUIL_CFLAGS = @SUIL_CFLAGS@
LIBXML_CFLAGS = @LIBXML_CFLAGS@
LIBSMF_CFLAGS = @LIBSMF_CFLAGS@
PORTAUDIO_CFLAGS = @PORTAUDIO_CFLAGS@
SAMPLERATE_CFLAGS = @SAMPLERATE_CFLAGS@
SNDFILE_CFLAGS = @SNDFILE_CFLAGS@

# library LIBS
#LIBCYAML_LIBS = @LIBCYAML_LIBS@
LIBYAML_LIBS = @LIBYAML_LIBS@
GTK3_LIBS = @GTK3_LIBS@
FFMPEG_LIBS = @FFMPEG_LIBS@
JACK_LIBS = @JACK_LIBS@
LIBDAZZLE_LIBS = @LIBDAZZLE_LIBS@
LILV_LIBS = @LILV_LIBS@
LV2_LIBS = @LV2_LIBS@
#SUIL_LIBS = @SUIL_LIBS@
LIBXML_LIBS = @LIBXML_LIBS@
LIBSMF_LIBS = @LIBSMF_LIBS@
PORTAUDIO_LIBS = @PORTAUDIO_LIBS@
SAMPLERATE_LIBS = @SAMPLERATE_LIBS@
SNDFILE_LIBS = @SNDFILE_LIBS@

DEFAULT_INCLUDES = -I. -I./$(INC_DIR) -I./$(SRC_DIR) -I./ext

ifeq ($(RELEASE),1)
	DEFAULT_CFLAGS += -O3
ifeq ($(PACKAGE_MODE),1)
	DEFAULT_CFLAGS += -g
endif
else
	DEFAULT_CFLAGS += -g -O0
endif

ifeq ($(PROFILING),1)
	DEFAULT_CFLAGS += -pg
endif

# -rdynamic gcc flag
ifeq ($(patsubst gcc%,gcc,$(CC)),gcc)
	R_DYNAMIC = -rdynamic
else ifeq ($(patsubst clang%,clang,$(patsubst cc,clang,$(CC))),clang)
	R_DYNAMIC = -Wl,--export-dynamic
else ifeq ($(CC),x86_64-w64-mingw32-gcc)
	#R_DYNAMIC = -export-all-symbols
endif

ifeq ($(WINDOWS),1)
	EXT = .exe
	EXTRA_LD_FLAGS += -fno-stack-protector -mwindows
else
ifneq ($(RELEASE),1)
#	EXTRA_LD_FLAGS += -pg
endif
#EXTRA_LD_FLAGS += -DGDK_DISABLE_DEPRECATED \
#									 -DGTK_DISABLE_DEPRECATED
endif

#$(LIBCYAML_CFLAGS) \
#$(SUIL_CFLAGS) \

# FIXME don't override CFLAGS
CFLAGS = -Wall \
	$(DEFAULT_INCLUDES) \
	$(FFMPEG_CFLAGS) \
	$(GTK3_CFLAGS) \
	$(JACK_CFLAGS) \
	$(LIBDAZZLE_CFLAGS) \
	$(LIBSMF_CFLAGS) \
	$(LIBXML_CFLAGS) \
	$(LIBYAML_CFLAGS) \
	$(LILV_CFLAGS) \
	$(LV2_CFLAGS) \
	$(PORTAUDIO_CFLAGS) \
	$(SAMPLERATE_CFLAGS) \
	$(SNDFILE_CFLAGS) \
	$(DEFAULT_CFLAGS)

#$(LIBCYAML_LIBS) \
#$(SUIL_LIBS) \

LDFLAGS =	\
  $(GTK3_LIBS) \
	$(FFMPEG_LIBS) \
	$(JACK_LIBS) \
	$(LIBDAZZLE_LIBS) \
	$(LIBSMF_LIBS) \
	$(LIBXML_LIBS) \
	$(LIBYAML_LIBS) \
	$(LILV_LIBS) \
	$(LV2_LIBS) \
	$(PORTAUDIO_LIBS) \
	$(SAMPLERATE_LIBS) \
	$(SNDFILE_LIBS) \
	$(EXTRA_LD_FLAGS) \
 	$(R_DYNAMIC) \
	-lrt \
	-lasound \
	-lm \
	-lpthread

ifeq ($(PROFILING),1)
	DEFAULT_LDFLAGS += -pg
endif

built_src = $(BUILD_DIR)/resources.c
built_obj = $(built_src:%.c=$(BUILD_DIR/%.o))
built_dep = $(built_obj:%.o=%.d))

#Find all the C++ files in the src/ directory
SRCS = $(shell find src/ -name "*.c") \
			 $(shell find ext/audio_decoder -name "*.c")
# All .o files go to build dir.
OBJ = $(SRCS:%.c=$(BUILD_DIR)/%.o)
# Gcc/Clang will create these .d files containing dependencies.
DEP = $(OBJ:%.o=%.d)

gsettings_SCHEMAS = org.zrythm.gschema.xml
#EXTRA_DIST = $(gsettings_SCHEMAS)

# desktop file
desktopdir = $(datadir)/applications
desktop_DATA = zrythm.desktop

#the application icon
appicondir=$(datadir)/icons/hicolor/scalable/apps
appicon_DATA_srcdir = resources/icons/zrythm
appicon_DATA = z.svg

# static libs

# -----------------------------
#  rules
#  ----------------------------

# Default target named after the binary.
$(BIN) : $(BUILD_DIR)/$(BIN)$(EXT)

# Actual target of the binary - depends on all .o files.
$(BUILD_DIR)/$(BIN)$(EXT): $(OBJ) $(BUILD_DIR)/resources.o ext/libcyaml/build/release/libcyaml.a ext/suil/build/libsuil-0.a
	# Create build directories - same structure as sources.
	echo $(CYAML_BUILD_DIR)
	$(MKDIR_P) $(@D)
	# Just link all the object files.
	$(CC) $^ $(LDFLAGS) -o $@
	# done

# build libcyaml
$(CYAML_BUILD_DIR)/libcyaml.a:
	cd $(CYAML_SRC_DIR) && make VARIANT=release

# build suil
$(SUIL_BUILD_DIR)/libsuil-0.a:
	cd $(SUIL_SRC_DIR) && ./waf configure --static --prefix=$(PREFIX) && ./waf

$(BUILD_DIR)/zrythm.gresource.xml: resources/gen-gtk-gresources-xml.py \
	resources/theme.css \
	resources/ui/*.ui \
	resources/icons/zrythm/*.svg \
	resources/icons/gnome-builder/*.svg
	resources/gen-gtk-gresources-xml.py resources $@

$(BUILD_DIR)/resources.c: $(BUILD_DIR)/zrythm.gresource.xml
	$(MKDIR_P) $(BUILD_DIR)
	glib-compile-resources $(BUILD_DIR)/zrythm.gresource.xml --target=$(BUILD_DIR)/resources.c \
	--generate-source --sourcedir=resources

# Include all dep files
-include $(DEP)

# Build target for every single object file.
# The potential dependency on header files is covered
# by calling `-include $(DEP)`.
# The -MMD flags additionaly creates a .d file with
# the same name as the .o file.
$(BUILD_DIR)/%.$(OBJEXT): %.c
	$(MKDIR_P) $(dir $@)
	$(CC) $(CFLAGS) -I./ext/suil -I./ext/libcyaml/include -MMD -c $< -o $@

.PHONY: clean
clean:
	#rm -rf $(BUILD_DIR)/*
	# This should remove all generated files.
	-rm $(BUILD_DIR)/$(BIN)$(EXT) $(OBJ) $(DEP)
	-rm $(BUILD_DIR)/zrythm.gresource.xml
	-rm -rf $(CYAML_SRC_DIR)/build/*
	-rm -rf $(SUIL_SRC_DIR)/build/*

.PHONY: install
install: $(BUILD_DIR)/$(BIN)$(EXT) install-appicon-data install-desktop-data install-gschemas install-fonts install-suil-sos
	$(MKDIR_P) $(DESTDIR)$(bindir)
	$(INSTALL) $< $(DESTDIR)$(bindir)/$(BIN)$(EXT)

.PHONY: install-suil-sos
install-suil-sos: $(SUIL_BUILD_DIR)/libsuil_x11.so $(SUIL_BUILD_DIR)/libsuil_x11_in_gtk3.so
	$(MKDIR_P) $(DESTDIR)$(libdir)
	$(INSTALL) $(SUIL_BUILD_DIR)/libsuil_x11.so $(DESTDIR)$(libdir)/
	$(INSTALL) $(SUIL_BUILD_DIR)/libsuil_x11_in_gtk3.so $(DESTDIR)$(libdir)/

.PHONY: uninstall
uninstall: uninstall-appicon-data uninstall-gschemas uninstall-desktop
	rm -f $(bindir)/$(BIN)$(EXT)

.PHONY: install-appicon-data
install-appicon-data: $(appicon_DATA_srcdir)/$(appicon_DATA)
	$(MKDIR_P) "$(DESTDIR)$(appicondir)"
	$(INSTALL_DATA) $< "$(DESTDIR)$(appicondir)/"

.PHONY: uninstall-appicon-data
uninstall-appicon-data:
	rm -f $< "$(DESTDIR)$(appicondir)/$(appicon_DATA)"

.PHONY: install-gschemas
install-gschemas: $(DATA_DIR)/$(gsettings_SCHEMAS)
	$(MKDIR_P) "$(DESTDIR)$(gsettingsschemadir)"
	$(INSTALL_DATA) $< "$(DESTDIR)$(gsettingsschemadir)/"
ifneq ($(PACKAGE_MODE),1)
ifeq ($(DESTDIR),)
	$(GLIB_COMPILE_SCHEMAS) "$(DESTDIR)$(gsettingsschemadir)"
endif
endif

.PHONY: uninstall-gschemas
uninstall-gschemas:
	rm -f $(gsettingsschemadir)/$(gsettings_SCHEMAS)
	$(GLIB_COMPILE_SCHEMAS) "$(DESTDIR)$(gsettingsschemadir)"

.PHONY: install-fonts
install-fonts: $(FONTS_DIR)/Segment7Standard/*
	$(MKDIR_P) "$(DESTDIR)$(fontdir)/$(BIN)/Segment7Standard"
	$(INSTALL_FONT) $< "$(DESTDIR)$(fontdir)/$(BIN)/Segment7Standard/"

.PHONY: install-desktop
install-desktop-data: $(DATA_DIR)/$(desktop_DATA)
	$(MKDIR_P) "$(DESTDIR)$(desktopdir)"
	$(INSTALL_DATA) $< "$(DESTDIR)$(desktopdir)/"

.PHONY: uninstall-desktop
uninstall-desktop-data:
	rm -f $(desktopdir)/$(desktop_DATA)
